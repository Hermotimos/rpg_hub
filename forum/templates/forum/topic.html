{% extends 'base.html' %}
{% load custom_filters %}
{% load crispy_forms_tags %}

{% block head_extra %}
{{ post_form.media }}
{% endblock head_extra %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{% url 'forum' %}">Wieczorne narady</a></li>
    <li class="breadcrumb-item active">{{ page_title }}</li>
{% endblock breadcrumb %}

{% block content %}
     <br>
    {% if request.user.profile not in topic.allowed_profiles.all and request.user.profile.character_status != 'gm' %}
       <h4>Nie jesteś uczestnikiem tej narady</h4>
    {% else %}
        <h6>Temat: <small>{{ topic.board.title }}</small></h6>
        <h6>Inicjator: <small>{{ topic.starter.profile.character_name }}</small></h6>
        <h6>
            Uczestnicy:
            {% for profile in topic.allowed_profiles.all %}
                {% if profile.character_name != 'MG' %}
                    {% if forloop.counter > 1 %}
                        <small>/ {{ profile }}</small>
                    {% else %}
                        <small>{{ profile }}</small>
                    {% endif %}
                {% endif %}
              {% endfor %}
        </h6>
        <br>
        <div class="mb-4">
            <a href="{% url 'update_topic' topic.board.slug topic.slug %}" class="btn btn-success">Dodaj uczestników narady</a>
        </div>
        <br>

        {% for post in topic.posts.all %}
            {% if post.author.profile.character_name == 'MG' %}
                <table class="posts-and-news">
                <tbody>
                    <div>
                        <tr class="posts-and-news-mg">
                            <td>
                                <p>{{ post.text|capfirst|linebreaks }}</p>
                                {% if post.image %}
                                    <img src="{{ post.image.url }}">
                                {% endif %}
                            </td>
                        </tr>
                    </div>
                </tbody>
                </table>

            {% else %}
                <table class="posts-and-news">
                    <tbody>
                        <div>
                        <tr class="posts-and-news">
                            <td>
                                <img class="rounded-circle article-img" src="{{ post.author.profile.image.url }}">
                                <small><p>{{ post.author.profile.character_name }}</p></small>
                            </td>
                            <td>
                                <small>{{ post.date_posted|date:'d-M-Y' }}</small>
                                <p>{{ post.text|capfirst|linebreaks }}</p>
                                {% if post.image %}
                                    <img src="{{ post.image.url }}">
                                {% endif %}
                            </td>
                        </tr>
                        </div>
                    </tbody>
                </table>
            {% endif %}
        {% endfor %}
        <br><br>

        <form method="POST" action=".#page-bottom" enctype="multipart/form-data">
            {% csrf_token %}
            {{ post_form|crispy }}
            <input class="btn btn-outline-info" type="submit" value="Tak rzeknij"}}>
        </form>

    {% endif %}
{% endblock content %}