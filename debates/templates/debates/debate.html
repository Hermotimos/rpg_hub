{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load crispy_forms_tags %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'css/debates.css' %}">
{% endblock head_extra %}

{% block content %}
    <article class="top-space">
        
        <header class="mb-3 mb-sm-5">
            <table>
                <tr>
                    <td><h5>Temat:</h5></td>
                    <td><h5>{{ debate.topic.title }}</h5></td>
                </tr>
                <tr>
                    <td class="align-middle">
                        <h5 class="mb-0 mr-2 mr-sm-3">Uczestnicy:</h5>
                    </td>
                    <td>
                        {% for profile in debate_allowed_profiles %}
                            <img class="rounded-circle img-small" src="{{ profile.image.url }}" alt="Profile img">
                        {% endfor %}
                    </td>
                </tr>
                <tr>
                    <td class="align-middle">
                        <h5 class="mb-0 mr-2 mr-sm-3 text-nowrap">Uważni uczestnicy:</h5>
                    </td>
                    <td>
                        {% for profile in debate_followers %}
                            <img class="rounded-circle img-small" src="{{ profile.image.url }}" alt="Profile img">
                        {% endfor %}
                    </td>
                </tr>
            </table>

            {% if not debate.is_ended %}
                <div class="my-4">
                    <p class="btn btn-outline-dark icon-inform mt-1" data-toggle="modal" data-target="#infoLocationModal"></p>
                        <!-- The Modal -->
                        <div class="modal fade" id="infoLocationModal" tabindex="-1" role="dialog" aria-hidden="true">
                            {% with informable=debate.informable inform_type='debate' %}
                                {% include '_inform.html' %}
                            {% endwith %}
                        </div>
                    {% if request.user.profile in debate_followers %}
                        <a href="{% url 'debates:unfollow' topic.id debate.id %}" class="align-top btn btn-dark mt-1">Nie obserwuj</a>
                    {% else %}
                        <a href="{% url 'debates:follow' topic.id debate.id %}" class="align-top btn btn-dark mt-1">Obserwuj</a>
                    {% endif %}
                </div>
            {% endif %}
            
        </header>
        
        
        <table>
            <tbody>
            
                <!-- REMARKS -->
                {% for remark in remarks %}
                    {% if remark.author.profile.status == 'gm' %}
                        <tr>
                            <td colspan="2" class="font-18 font-italic text-justify">
                                {{ remark.text|capfirst|linebreaks }}
                                {% if remark.image %}
                                    <p><img class="img-fluid mx-auto d-block" src="{{ remark.image.url }}" alt="Remark img"></p>
                                    <br>
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td class="align-top align-center py-3 px-sm-2">
                                <img class="rounded-circle article-img" src="{{ remark.author.profile.image.url }}" alt="Profile img">
                                <br>
                                <small class="font-12 font-italic sm-nowrap text-muted">{{ remark.author.profile.character_name }}</small>
                            </td>
                            <td class="align-top font-18 font-italic px-2 py-2 text-justify">
                                <small class="text-muted">{{ remark.date_posted|date:'d-M-Y | H:i' }}</small><br>
                                {{ remark.text|capfirst|linebreaks }}
                                {% if remark.image %}
                                    <p><img class="img-fluid mx-auto d-block" src="{{ remark.image.url }}" alt="Remark img"></p>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
                
                <!-- SEEN BY -->
                <tr>
                    {% if not debate.is_ended %}
                        {% if last_remark.author.profile.status == 'gm' %}
                            <td>
                                {% for image in last_remark_seen_by_imgs %}
                                    <img class="rounded-circle img-small" src="{{ image.url }}" alt="Profile small img">
                                {% endfor %}
                            </td>
                        {% else %}
                            <td></td>
                            <td>
                                {% for image in last_remark_seen_by_imgs %}
                                    <img class="rounded-circle img-small" src="{{ image.url }}" alt="Profile small img">
                                {% endfor %}
                            </td>
                        {% endif %}
                    {% endif %}
                </tr>
            </tbody>
        </table>
        <br><br>
    
        {% if debate.is_ended %}
            <h4><b>Tak zakończyła się Wasza rozmowa.</b></h4><br>
        {% else %}
        
            <div id="page-bottom">
                <br>
                <form method="POST" action=".#page-bottom" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% if request.user.profile.status == 'gm' %}
                        <div class="col-md-3">
                            {{ form.author|as_crispy_field }}
                        </div>
                    {% else %}
                    <!--  necessary for form to validate - hidden author form field  -->
                        <div class="collapse">
                            {{ form.author }}
                        </div>
                    {% endif %}
                    {{ form.author.errors }}
    
                    <div class="col-md-12">
                        {{ form.text|as_crispy_field }}
                    </div>
                    {{ form.image|as_crispy_field }}
                    <input class="btn btn-dark" type="submit" value="Tak rzeknij">
                </form>
            </div>
        {% endif %}
        
    </article>
{% endblock content %}
